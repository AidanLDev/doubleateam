version: 2.1

description: |
  copy files to S3 bucket and then create an Cloudfront invalidation
  on the distribution.

jobs:
  build:
    docker:
      # Next-gen CircleCI image (replaces deprecated circleci/python:latest)
      - image: cimg/python:3.12

    steps:
      - checkout

      # Install AWS CLI v2
      - run:
          name: Install AWS CLI
          command: |
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
            aws --version

      # Verify AWS credentials are configured
      - run:
          name: Verify AWS credentials
          command: |
            if [ -z "${AWS_ACCESS_KEY}" ] || [ -z "${AWS_SECRET_ACCESS_KEY}" ]; then
              echo "ERROR: AWS credentials not found!"
              echo "Please set AWS_ACCESS_KEY and AWS_SECRET_ACCESS_KEY in CircleCI project settings."
              echo "Go to: Project Settings → Environment Variables"
              exit 1
            fi
            echo "AWS credentials found ✓"
            # AWS CLI expects AWS_ACCESS_KEY_ID, so export it from AWS_ACCESS_KEY
            export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY}"
            # AWS CLI prefers AWS_DEFAULT_REGION, so export it from AWS_REGION
            if [ -n "${AWS_REGION}" ]; then
              export AWS_DEFAULT_REGION="${AWS_REGION}"
              echo "Using region: ${AWS_REGION}"
            elif [ -z "${AWS_DEFAULT_REGION}" ]; then
              echo "WARNING: AWS_REGION not set, using us-east-1"
              export AWS_DEFAULT_REGION=us-east-1
            fi

      # Sync dist directory to S3
      - run:
          name: Deploy to S3
          command: |
            # AWS CLI expects AWS_ACCESS_KEY_ID, so export it from AWS_ACCESS_KEY
            export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY}"
            # AWS CLI prefers AWS_DEFAULT_REGION, so export it from AWS_REGION
            if [ -n "${AWS_REGION}" ]; then
              export AWS_DEFAULT_REGION="${AWS_REGION}"
            elif [ -z "${AWS_DEFAULT_REGION}" ]; then
              export AWS_DEFAULT_REGION=us-east-1
            fi

            aws s3 sync dist s3://blog.aidanlowson.com \
              --acl public-read \
              --cache-control "max-age=86400" \
              --exclude ".git/*" \
              --exclude ".gitignore" \
              --exclude ".circleci/*" \
              --delete

      # Invalidate CloudFront cache to show updated content immediately
      - run:
          name: Invalidate CloudFront Cache
          command: |
            # AWS CLI expects AWS_ACCESS_KEY_ID, so export it from AWS_ACCESS_KEY
            export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY}"
            # AWS CLI prefers AWS_DEFAULT_REGION, so export it from AWS_REGION
            if [ -n "${AWS_REGION}" ]; then
              export AWS_DEFAULT_REGION="${AWS_REGION}"
            elif [ -z "${AWS_DEFAULT_REGION}" ]; then
              export AWS_DEFAULT_REGION=us-east-1
            fi

            # Check if CloudFront distribution ID is set
            if [ -z "${CLOUDFRONT_DISTRIBUTION_ID}" ]; then
              echo "WARNING: CLOUDFRONT_DISTRIBUTION_ID not set. Skipping CloudFront invalidation."
              echo "To enable cache invalidation, add CLOUDFRONT_DISTRIBUTION_ID in CircleCI Environment Variables."
              echo "Old content may still be cached and visible on your site until cache expires."
              exit 0
            fi

            echo "Creating CloudFront invalidation for distribution: ${CLOUDFRONT_DISTRIBUTION_ID}"
            INVALIDATION_ID=$(aws cloudfront create-invalidation \
              --distribution-id "${CLOUDFRONT_DISTRIBUTION_ID}" \
              --paths "/*" \
              --query 'Invalidation.Id' \
              --output text)

            echo "CloudFront invalidation created: ${INVALIDATION_ID}"
            echo "Cache will be cleared within a few minutes. Your updated content will be visible shortly."

workflows:
  version: 2
  build:
    jobs:
      - build
    branches:
      ignore: main
